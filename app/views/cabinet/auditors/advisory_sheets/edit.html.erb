<div class="max-w-4xl mx-auto space-y-6">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold text-gray-900"><%= t('.title') %> #<%= @sheet.recording %></h1>
    <%= link_to "← #{t('.back')}", cabinet_auditors_advisory_sheet_path(@sheet), class: "text-blue-600 hover:text-blue-800" %>
  </div>

  <%= form_with model: @sheet, url: cabinet_auditors_advisory_sheet_path(@sheet), method: :patch, local: true, html: { class: "space-y-6" } do |f| %>
    <%= render "shared/errors", resource: @sheet %>

    <!-- Основная информация -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4"><%= t('.basic_info') %></h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <%= f.label :recording, t('.recording'), class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.text_field :recording, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500", readonly: true %>
          <p class="mt-1 text-xs text-gray-500"><%= t('.recording_readonly') %></p>
        </div>

        <div>
          <%= f.label :status, t('.status'), class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.select :status,
              options_for_select([
                [t('.status_red'), 'red'],
                [t('.status_yellow'), 'yellow'],
                [t('.status_green'), 'green'],
                [t('.status_purple'), 'purple']
              ], @sheet.status),
              {},
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" %>
        </div>

        <div class="md:col-span-2">
          <%= f.label :original_filename, t('.original_filename'), class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.text_field :original_filename, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500", readonly: true %>
        </div>
      </div>
    </div>

    <!-- Результаты проверки -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4"><%= t('.verification_results') %></h2>

      <div class="space-y-4">
        <div>
          <%= f.label :verification_result, t('.verification_result'), class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.text_area :verification_result, rows: 6, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" %>
        </div>

        <div>
          <%= f.label :recommendations, t('.recommendations'), class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.text_area :recommendations, rows: 4, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" %>
        </div>
      </div>
    </div>

    <!-- Содержимое КЛ -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4"><%= t('.body') %></h2>
      <%= f.text_area :body, rows: 10, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" %>
    </div>

    <!-- Ключевые поля консультативного листа -->
    <% if @sheet.advisory_sheet_field.present? %>
      <%= f.fields_for :advisory_sheet_field do |field_form| %>
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4"><%= t('.medical_fields') %></h2>

          <div class="space-y-6">
            <!-- Жалобы -->
            <div class="border-l-4 border-blue-500 pl-4">
              <%= field_form.label :complaints, t('.complaints'), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= field_form.text_area :complaints, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-2" %>

              <%= field_form.label :complaints_comment, t('.ai_comment'), class: "block text-xs font-medium text-yellow-700 mb-1" %>
              <%= field_form.text_area :complaints_comment, rows: 2, class: "w-full px-3 py-2 border border-yellow-300 bg-yellow-50 rounded-md focus:ring-yellow-500 focus:border-yellow-500 text-sm" %>
            </div>

            <!-- Anamnesis morbi -->
            <div class="border-l-4 border-blue-500 pl-4">
              <%= field_form.label :anamnesis_morbi, t('.anamnesis_morbi'), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= field_form.text_area :anamnesis_morbi, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-2" %>

              <%= field_form.label :anamnesis_morbi_comment, t('.ai_comment'), class: "block text-xs font-medium text-yellow-700 mb-1" %>
              <%= field_form.text_area :anamnesis_morbi_comment, rows: 2, class: "w-full px-3 py-2 border border-yellow-300 bg-yellow-50 rounded-md focus:ring-yellow-500 focus:border-yellow-500 text-sm" %>
            </div>

            <!-- Anamnesis vitae -->
            <div class="border-l-4 border-blue-500 pl-4">
              <%= field_form.label :anamnesis_vitae, t('.anamnesis_vitae'), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= field_form.text_area :anamnesis_vitae, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-2" %>

              <%= field_form.label :anamnesis_vitae_comment, t('.ai_comment'), class: "block text-xs font-medium text-yellow-700 mb-1" %>
              <%= field_form.text_area :anamnesis_vitae_comment, rows: 2, class: "w-full px-3 py-2 border border-yellow-300 bg-yellow-50 rounded-md focus:ring-yellow-500 focus:border-yellow-500 text-sm" %>
            </div>

            <!-- Объективный осмотр -->
            <div class="border-l-4 border-blue-500 pl-4">
              <%= field_form.label :physical_examination, t('.physical_examination'), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= field_form.text_area :physical_examination, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-2" %>

              <%= field_form.label :physical_examination_comment, t('.ai_comment'), class: "block text-xs font-medium text-yellow-700 mb-1" %>
              <%= field_form.text_area :physical_examination_comment, rows: 2, class: "w-full px-3 py-2 border border-yellow-300 bg-yellow-50 rounded-md focus:ring-yellow-500 focus:border-yellow-500 text-sm" %>
            </div>

            <!-- Протокол исследования -->
            <div class="border-l-4 border-blue-500 pl-4">
              <%= field_form.label :study_protocol, t('.study_protocol'), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= field_form.text_area :study_protocol, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-2" %>

              <%= field_form.label :study_protocol_comment, t('.ai_comment'), class: "block text-xs font-medium text-yellow-700 mb-1" %>
              <%= field_form.text_area :study_protocol_comment, rows: 2, class: "w-full px-3 py-2 border border-yellow-300 bg-yellow-50 rounded-md focus:ring-yellow-500 focus:border-yellow-500 text-sm" %>
            </div>

            <!-- Диагнозы (JSON) -->
            <div class="border-l-4 border-red-500 pl-4">
              <label class="block text-sm font-medium text-gray-700 mb-1"><%= t('.diagnoses') %></label>
              <p class="text-xs text-gray-500 mb-2"><%= t('.diagnoses_hint') %></p>
              <% diagnoses = @sheet.advisory_sheet_field.diagnoses || {} %>
              <div class="space-y-2 mb-2">
                <input type="text"
                       name="verified_advisory_sheet[advisory_sheet_field_attributes][diagnoses][mkb_code]"
                       value="<%= diagnoses['mkb_code'] %>"
                       placeholder="<%= t('.mkb_code') %>"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">

                <input type="text"
                       name="verified_advisory_sheet[advisory_sheet_field_attributes][diagnoses][main_disease]"
                       value="<%= diagnoses['main_disease'] %>"
                       placeholder="<%= t('.main_disease') %>"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">

                <input type="text"
                       name="verified_advisory_sheet[advisory_sheet_field_attributes][diagnoses][diagnosis_type]"
                       value="<%= diagnoses['diagnosis_type'] %>"
                       placeholder="<%= t('.diagnosis_type') %>"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
              </div>

              <%= field_form.label :diagnoses_comment, t('.ai_comment'), class: "block text-xs font-medium text-yellow-700 mb-1" %>
              <%= field_form.text_area :diagnoses_comment, rows: 2, class: "w-full px-3 py-2 border border-yellow-300 bg-yellow-50 rounded-md focus:ring-yellow-500 focus:border-yellow-500 text-sm" %>
            </div>

            <!-- Направления -->
            <div class="border-l-4 border-blue-500 pl-4">
              <%= field_form.label :referrals, t('.referrals'), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= field_form.text_area :referrals, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-2" %>

              <%= field_form.label :referrals_comment, t('.ai_comment'), class: "block text-xs font-medium text-yellow-700 mb-1" %>
              <%= field_form.text_area :referrals_comment, rows: 2, class: "w-full px-3 py-2 border border-yellow-300 bg-yellow-50 rounded-md focus:ring-yellow-500 focus:border-yellow-500 text-sm" %>
            </div>

            <!-- Назначения -->
            <div class="border-l-4 border-blue-500 pl-4">
              <%= field_form.label :prescriptions, t('.prescriptions'), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= field_form.text_area :prescriptions, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-2" %>

              <%= field_form.label :prescriptions_comment, t('.ai_comment'), class: "block text-xs font-medium text-yellow-700 mb-1" %>
              <%= field_form.text_area :prescriptions_comment, rows: 2, class: "w-full px-3 py-2 border border-yellow-300 bg-yellow-50 rounded-md focus:ring-yellow-500 focus:border-yellow-500 text-sm" %>
            </div>

            <!-- Рекомендации врача -->
            <div class="border-l-4 border-blue-500 pl-4">
              <%= field_form.label :recommendations, t('.field_recommendations'), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= field_form.text_area :recommendations, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-2" %>

              <%= field_form.label :recommendations_comment, t('.ai_comment'), class: "block text-xs font-medium text-yellow-700 mb-1" %>
              <%= field_form.text_area :recommendations_comment, rows: 2, class: "w-full px-3 py-2 border border-yellow-300 bg-yellow-50 rounded-md focus:ring-yellow-500 focus:border-yellow-500 text-sm" %>
            </div>

            <!-- Примечания -->
            <div class="border-l-4 border-purple-500 pl-4">
              <%= field_form.label :notes, t('.notes'), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= field_form.text_area :notes, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-2" %>

              <%= field_form.label :notes_comment, t('.ai_comment'), class: "block text-xs font-medium text-yellow-700 mb-1" %>
              <%= field_form.text_area :notes_comment, rows: 2, class: "w-full px-3 py-2 border border-yellow-300 bg-yellow-50 rounded-md focus:ring-yellow-500 focus:border-yellow-500 text-sm" %>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>

    <!-- Оценка качества заполнения -->
    <% if @sheet.advisory_sheet_score.present? %>
      <%= f.fields_for :advisory_sheet_score do |score_form| %>
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4"><%= t('.quality_scores') %></h2>
          <p class="text-sm text-gray-600 mb-4"><%= t('.quality_scores_hint') %></p>

          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div>
              <%= score_form.label :complaints_score, t('.complaints'), class: "block text-xs font-medium text-gray-700 mb-1" %>
              <%= score_form.select :complaints_score,
                  options_for_select([['0.0', 0.0], ['0.5', 0.5], ['1.0', 1.0]], @sheet.advisory_sheet_score.complaints_score),
                  {},
                  class: "w-full px-2 py-1 border border-gray-300 rounded-md text-sm" %>
            </div>

            <div>
              <%= score_form.label :anamnesis_morbi_score, t('.anamnesis_morbi'), class: "block text-xs font-medium text-gray-700 mb-1" %>
              <%= score_form.select :anamnesis_morbi_score,
                  options_for_select([['0.0', 0.0], ['0.5', 0.5], ['1.0', 1.0]], @sheet.advisory_sheet_score.anamnesis_morbi_score),
                  {},
                  class: "w-full px-2 py-1 border border-gray-300 rounded-md text-sm" %>
            </div>

            <div>
              <%= score_form.label :anamnesis_vitae_score, t('.anamnesis_vitae'), class: "block text-xs font-medium text-gray-700 mb-1" %>
              <%= score_form.select :anamnesis_vitae_score,
                  options_for_select([['0.0', 0.0], ['0.5', 0.5], ['1.0', 1.0]], @sheet.advisory_sheet_score.anamnesis_vitae_score),
                  {},
                  class: "w-full px-2 py-1 border border-gray-300 rounded-md text-sm" %>
            </div>

            <div>
              <%= score_form.label :physical_examination_score, t('.physical_examination'), class: "block text-xs font-medium text-gray-700 mb-1" %>
              <%= score_form.select :physical_examination_score,
                  options_for_select([['0.0', 0.0], ['0.5', 0.5], ['1.0', 1.0]], @sheet.advisory_sheet_score.physical_examination_score),
                  {},
                  class: "w-full px-2 py-1 border border-gray-300 rounded-md text-sm" %>
            </div>

            <div>
              <%= score_form.label :study_protocol_score, t('.study_protocol'), class: "block text-xs font-medium text-gray-700 mb-1" %>
              <%= score_form.select :study_protocol_score,
                  options_for_select([['0.0', 0.0], ['0.5', 0.5], ['1.0', 1.0]], @sheet.advisory_sheet_score.study_protocol_score),
                  {},
                  class: "w-full px-2 py-1 border border-gray-300 rounded-md text-sm" %>
            </div>

            <div>
              <%= score_form.label :diagnoses_score, t('.diagnoses'), class: "block text-xs font-medium text-gray-700 mb-1" %>
              <%= score_form.select :diagnoses_score,
                  options_for_select([['0.0', 0.0], ['0.5', 0.5], ['1.0', 1.0]], @sheet.advisory_sheet_score.diagnoses_score),
                  {},
                  class: "w-full px-2 py-1 border border-gray-300 rounded-md text-sm" %>
            </div>

            <div>
              <%= score_form.label :referrals_score, t('.referrals'), class: "block text-xs font-medium text-gray-700 mb-1" %>
              <%= score_form.select :referrals_score,
                  options_for_select([['0.0', 0.0], ['0.5', 0.5], ['1.0', 1.0]], @sheet.advisory_sheet_score.referrals_score),
                  {},
                  class: "w-full px-2 py-1 border border-gray-300 rounded-md text-sm" %>
            </div>

            <div>
              <%= score_form.label :prescriptions_score, t('.prescriptions'), class: "block text-xs font-medium text-gray-700 mb-1" %>
              <%= score_form.select :prescriptions_score,
                  options_for_select([['0.0', 0.0], ['0.5', 0.5], ['1.0', 1.0]], @sheet.advisory_sheet_score.prescriptions_score),
                  {},
                  class: "w-full px-2 py-1 border border-gray-300 rounded-md text-sm" %>
            </div>

            <div>
              <%= score_form.label :recommendations_score, t('.field_recommendations'), class: "block text-xs font-medium text-gray-700 mb-1" %>
              <%= score_form.select :recommendations_score,
                  options_for_select([['0.0', 0.0], ['0.5', 0.5], ['1.0', 1.0]], @sheet.advisory_sheet_score.recommendations_score),
                  {},
                  class: "w-full px-2 py-1 border border-gray-300 rounded-md text-sm" %>
            </div>

            <div>
              <%= score_form.label :notes_score, t('.notes'), class: "block text-xs font-medium text-gray-700 mb-1" %>
              <%= score_form.select :notes_score,
                  options_for_select([['0.0', 0.0], ['0.5', 0.5], ['1.0', 1.0]], @sheet.advisory_sheet_score.notes_score),
                  {},
                  class: "w-full px-2 py-1 border border-gray-300 rounded-md text-sm" %>
            </div>
          </div>

          <div class="mt-4 p-4 bg-blue-50 rounded-md">
            <p class="text-sm text-blue-800"><%= t('.scores_auto_calculate') %></p>
          </div>
        </div>
      <% end %>
    <% end %>

    <!-- Кнопки действий -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <%= link_to t('.cancel'), cabinet_auditors_advisory_sheet_path(@sheet), class: "px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md" %>
        <%= f.submit t('.save'), class: "px-6 py-2 text-white bg-blue-600 hover:bg-blue-700 rounded-md font-medium" %>
      </div>
    </div>
  <% end %>
</div>
