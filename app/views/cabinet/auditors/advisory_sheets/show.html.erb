<div class="max-w-4xl mx-auto space-y-6">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold text-gray-900">Консультативный лист #<%= @sheet.recording %></h1>
    <%= link_to "← Назад", cabinet_auditors_advisory_sheets_path, class: "text-blue-600 hover:text-blue-800" %>
  </div>

  <!-- Статус -->
  <div class="bg-white rounded-lg shadow p-6">
    <div class="flex items-center space-x-4">
      <span class="inline-block w-6 h-6 rounded-full" style="background-color: <%= @sheet.status_color %>"></span>
      <span class="text-xl font-semibold"><%= @sheet.status_label %></span>
    </div>
  </div>

  <!-- Результат проверки -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Результат проверки</h2>
    <p class="text-gray-700 whitespace-pre-wrap"><%= @sheet.verification_result %></p>
  </div>

  <% if @sheet.recommendations.present? %>
    <div class="bg-yellow-50 rounded-lg shadow p-6 border-l-4 border-yellow-500">
      <h2 class="text-lg font-semibold text-yellow-800 mb-4">Рекомендации</h2>
      <p class="text-yellow-700 whitespace-pre-wrap"><%= @sheet.recommendations %></p>
    </div>
  <% end %>

  <!-- Ключевые поля консультативного листа -->
  <% if @sheet.advisory_sheet_field.present? %>
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Ключевые поля</h2>
      <div class="space-y-4 overflow-x-auto">
        <% fields = @sheet.advisory_sheet_field %>

        <% if fields.complaints.present? %>
          <div class="border-l-2 border-blue-500 pl-4">
            <h3 class="font-medium text-gray-700 mb-1">Жалобы</h3>
            <p class="text-sm text-gray-600"><%= fields.complaints %></p>
            <% if fields.complaints_comment.present? %>
              <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 rounded px-2 py-1">
                <strong>Замечание:</strong> <%= fields.complaints_comment %>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if fields.anamnesis_morbi.present? %>
          <div class="border-l-2 border-blue-500 pl-4">
            <h3 class="font-medium text-gray-700 mb-1">Anamnesis morbi</h3>
            <p class="text-sm text-gray-600"><%= fields.anamnesis_morbi %></p>
            <% if fields.anamnesis_morbi_comment.present? %>
              <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 rounded px-2 py-1">
                <strong>Замечание:</strong> <%= fields.anamnesis_morbi_comment %>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if fields.anamnesis_vitae.present? %>
          <div class="border-l-2 border-blue-500 pl-4">
            <h3 class="font-medium text-gray-700 mb-1">Anamnesis vitae</h3>
            <p class="text-sm text-gray-600"><%= fields.anamnesis_vitae %></p>
            <% if fields.anamnesis_vitae_comment.present? %>
              <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 rounded px-2 py-1">
                <strong>Замечание:</strong> <%= fields.anamnesis_vitae_comment %>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if fields.physical_examination.present? %>
          <div class="border-l-2 border-blue-500 pl-4">
            <h3 class="font-medium text-gray-700 mb-1">Объективный осмотр</h3>
            <p class="text-sm text-gray-600"><%= fields.physical_examination %></p>
            <% if fields.physical_examination_comment.present? %>
              <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 rounded px-2 py-1">
                <strong>Замечание:</strong> <%= fields.physical_examination_comment %>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if fields.study_protocol.present? %>
          <div class="border-l-2 border-blue-500 pl-4">
            <h3 class="font-medium text-gray-700 mb-1">Протокол исследования</h3>
            <p class="text-sm text-gray-600"><%= fields.study_protocol %></p>
            <% if fields.study_protocol_comment.present? %>
              <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 rounded px-2 py-1">
                <strong>Замечание:</strong> <%= fields.study_protocol_comment %>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if fields.diagnoses.present? && fields.diagnoses.any? %>
          <div class="border-l-2 border-red-500 pl-4">
            <h3 class="font-medium text-gray-700 mb-1">Диагнозы</h3>
            <div class="text-sm text-gray-600 space-y-1">
              <% if fields.diagnoses['mkb_code'].present? %>
                <p><strong>Код МКБ:</strong> <%= fields.diagnoses['mkb_code'] %></p>
              <% end %>
              <% if fields.diagnoses['main_disease'].present? %>
                <p><strong>Основное заболевание:</strong> <%= fields.diagnoses['main_disease'] %></p>
              <% end %>
              <% if fields.diagnoses['diagnosis_type'].present? %>
                <p><strong>Вид диагноза:</strong> <%= fields.diagnoses['diagnosis_type'] %></p>
              <% end %>
            </div>
            <% if fields.diagnoses_comment.present? %>
              <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 rounded px-2 py-1">
                <strong>Замечание:</strong> <%= fields.diagnoses_comment %>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if fields.referrals.present? %>
          <div class="border-l-2 border-blue-500 pl-4">
            <h3 class="font-medium text-gray-700 mb-1">Направления</h3>
            <p class="text-sm text-gray-600"><%= fields.referrals %></p>
            <% if fields.referrals_comment.present? %>
              <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 rounded px-2 py-1">
                <strong>Замечание:</strong> <%= fields.referrals_comment %>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if fields.prescriptions.present? %>
          <div class="border-l-2 border-blue-500 pl-4">
            <h3 class="font-medium text-gray-700 mb-1">Назначения</h3>
            <p class="text-sm text-gray-600"><%= fields.prescriptions %></p>
            <% if fields.prescriptions_comment.present? %>
              <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 rounded px-2 py-1">
                <strong>Замечание:</strong> <%= fields.prescriptions_comment %>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if fields.recommendations.present? %>
          <div class="border-l-2 border-blue-500 pl-4">
            <h3 class="font-medium text-gray-700 mb-1">Рекомендации врача</h3>
            <p class="text-sm text-gray-600"><%= fields.recommendations %></p>
            <% if fields.recommendations_comment.present? %>
              <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 rounded px-2 py-1">
                <strong>Замечание:</strong> <%= fields.recommendations_comment %>
              </div>
            <% end %>
          </div>
        <% end %>

        <% if fields.notes.present? %>
          <div class="border-l-2 border-purple-500 pl-4">
            <h3 class="font-medium text-gray-700 mb-1">Примечания</h3>
            <p class="text-sm text-gray-600"><%= fields.notes %></p>
            <% if fields.notes_comment.present? %>
              <div class="mt-2 text-xs text-yellow-700 bg-yellow-50 rounded px-2 py-1">
                <strong>Замечание:</strong> <%= fields.notes_comment %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Статистика заполненности -->
      <div class="mt-6 pt-4 border-t border-gray-200">
        <div class="flex items-center justify-between">
          <span class="text-sm font-medium text-gray-700">Заполненность полей:</span>
          <span class="text-sm font-semibold text-gray-900"><%= fields.filled_fields_count %> из 10 (<%= fields.completeness_percentage %>%)</span>
        </div>
        <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
          <div class="bg-blue-600 h-2 rounded-full" style="width: <%= fields.completeness_percentage %>%"></div>
        </div>
      </div>

      <!-- Оценка качества заполнения -->
      <% if @sheet.advisory_sheet_score.present? %>
        <% score = @sheet.advisory_sheet_score %>
        <div class="mt-6 pt-4 border-t border-gray-200">
          <h3 class="text-base font-semibold text-gray-900 mb-3">Оценка качества заполнения</h3>

          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bg-gray-50 rounded p-3">
              <p class="text-xs text-gray-500 mb-1">Итоговый балл</p>
              <p class="text-2xl font-bold text-gray-900"><%= score.total_score.round(1) %> / 10.0</p>
            </div>
            <div class="bg-gray-50 rounded p-3">
              <p class="text-xs text-gray-500 mb-1">Процент качества</p>
              <p class="text-2xl font-bold" style="color: <%= score.percentage_color %>"><%= score.percentage.round(1) %>%</p>
            </div>
          </div>

          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-700">Общая оценка:</span>
              <span class="text-sm font-semibold" style="color: <%= score.percentage_color %>"><%= score.quality_label %></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div class="h-3 rounded-full" style="width: <%= score.percentage %>%; background-color: <%= score.percentage_color %>"></div>
            </div>
          </div>

          <!-- Детальные баллы по полям -->
          <details class="mt-4">
            <summary class="cursor-pointer text-sm font-medium text-gray-700 hover:text-gray-900">Детальная разбивка баллов</summary>
            <div class="mt-3 space-y-2 text-sm">
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Жалобы:</span>
                <span class="font-medium <%= score_color_class(score.complaints_score) %>"><%= score.complaints_score %> / 1.0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Anamnesis morbi:</span>
                <span class="font-medium <%= score_color_class(score.anamnesis_morbi_score) %>"><%= score.anamnesis_morbi_score %> / 1.0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Anamnesis vitae:</span>
                <span class="font-medium <%= score_color_class(score.anamnesis_vitae_score) %>"><%= score.anamnesis_vitae_score %> / 1.0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Объективный осмотр:</span>
                <span class="font-medium <%= score_color_class(score.physical_examination_score) %>"><%= score.physical_examination_score %> / 1.0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Протокол исследования:</span>
                <span class="font-medium <%= score_color_class(score.study_protocol_score) %>"><%= score.study_protocol_score %> / 1.0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Диагнозы:</span>
                <span class="font-medium <%= score_color_class(score.diagnoses_score) %>"><%= score.diagnoses_score %> / 1.0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Направления:</span>
                <span class="font-medium <%= score_color_class(score.referrals_score) %>"><%= score.referrals_score %> / 1.0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Назначения:</span>
                <span class="font-medium <%= score_color_class(score.prescriptions_score) %>"><%= score.prescriptions_score %> / 1.0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Рекомендации врача:</span>
                <span class="font-medium <%= score_color_class(score.recommendations_score) %>"><%= score.recommendations_score %> / 1.0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Примечания:</span>
                <span class="font-medium <%= score_color_class(score.notes_score) %>"><%= score.notes_score %> / 1.0</span>
              </div>
            </div>
          </details>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Содержимое КЛ -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Содержимое консультативного листа</h2>
    <div class="bg-gray-50 rounded p-4 max-h-96 overflow-y-auto">
      <pre class="text-sm text-gray-700 whitespace-pre-wrap"><%= @sheet.body %></pre>
    </div>
  </div>

  <!-- Метаданные -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Информация</h2>
    <dl class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <dt class="text-gray-500">Дата проверки</dt>
        <dd class="font-medium"><%= @sheet.verified_at&.strftime("%d.%m.%Y %H:%M") %></dd>
      </div>
      <div>
        <dt class="text-gray-500">Исходный файл</dt>
        <dd class="font-medium"><%= @sheet.original_filename || "—" %></dd>
      </div>
    </dl>
  </div>

  <!-- Действие -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Действие</h2>
    <div class="flex gap-4">
      <%= link_to edit_cabinet_auditors_advisory_sheet_path(@sheet),
          class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-flex items-center" do %>
        <i class="bi bi-pencil-fill mr-2"></i>
        Редактировать
      <% end %>

      <%= button_to cabinet_auditors_advisory_sheet_path(@sheet),
          method: :delete,
          data: { turbo_confirm: t('are_you_sure') },
          class: "bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded inline-flex items-center",
          title: t('destroy') do %>
        <i class="bi bi-trash3-fill mr-2"></i>
        <%= t('destroy') %>
      <% end %>
    </div>
  </div>
</div>
