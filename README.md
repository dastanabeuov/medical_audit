# Medical Audit System

> AI-powered —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞—É–¥–∏—Ç–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ç–∏–≤–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤ (–ö–õ) –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ú–ö–ë-10/11 –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º –ú–ó –†–ö

## –û–ø–∏—Å–∞–Ω–∏–µ

Medical Audit System - —ç—Ç–æ Rails 8 –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—é—â–µ–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é RAG (Retrieval-Augmented Generation) –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞—É–¥–∏—Ç–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ç–∏–≤–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤.

### –ü—Ä–æ–±–ª–µ–º–∞

–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∞—É–¥–∏—Ç–æ—Ä—ã —Ç—Ä–∞—Ç—è—Ç —á–∞—Å—ã –Ω–∞ —Ä—É—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ—Ç–µ–Ω –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ç–∏–≤–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤, —Å–≤–µ—Ä—è—è –∏—Ö —Å –ú–ö–ë –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º–∏ –ú–ó –†–ö.

### –†–µ—à–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 100+ –ö–õ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–¥–∏–∞–≥–Ω–æ–∑, –ª–µ—á–µ–Ω–∏–µ, –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)
3. –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π (–ú–ö–ë + –ü—Ä–æ—Ç–æ–∫–æ–ª—ã)
4. –í—ã—è–≤–ª—è–µ—Ç –Ω–∞—Ä—É—à–µ–Ω–∏—è –∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
5. –í—ã—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ü–µ–Ω–∫—É 0-100 –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–æ —Ü–≤–µ—Ç–∞–º:
   - **–ö—Ä–∞—Å–Ω—ã–π** (< 50) - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
   - **–ñ–µ–ª—Ç—ã–π** (50-80) - –µ—Å—Ç—å –∑–∞–º–µ—á–∞–Ω–∏—è
   - **–ó–µ–ª–µ–Ω—ã–π** (80+) - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ê—É–¥–∏—Ç–æ—Ä—ã —Å—Ä–∞–∑—É –≤–∏–¥—è—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –ö–õ (–∫—Ä–∞—Å–Ω—ã–µ) –∏ –º–æ–≥—É—Ç —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ –Ω–∏—Ö, –≤–º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –ø–æ–¥—Ä—è–¥.

---

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### ü§ñ AI-Powered Analysis
- **RAG Pipeline**: –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ + semantic search –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
- **Claude Sonnet 4**: –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º
- **Smart Chunking**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **Context Window Management**: –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### Batch Processing
- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ 100+ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Solid Queue
- Real-time progress tracking
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### File Processing
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤: PDF, DOCX, TXT
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
- –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–§–ò–û, –ò–ò–ù, –¥–∏–∞–≥–Ω–æ–∑)
- Drag & Drop –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### Modern UI
- Tailwind CSS –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ ActionCable
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥—ã
- –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏

### Analytics & Reporting
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ batch
- –¢–æ–ø –Ω–∞—Ä—É—à–µ–Ω–∏–π
- –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF
- API –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π


---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend
- **Ruby** 3.4.3 - –Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
- **Rails** 8.0.4 - Web framework
- **PostgreSQL** 17 - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å pgvector extension
- **Solid Queue** - Background jobs (Rails 8 default)
- **Solid Cache** - Caching (Rails 8 default)
- **Solid Cable** - WebSocket (Rails 8 default)

### Frontend
- **Tailwind CSS** - Utility-first CSS framework
- **Stimulus** - JavaScript framework
- **Turbo** - SPA-like experience
- **ActionCable** - Real-time WebSocket

### AI & ML
- **Ruby LLM** - Unified AI interface
- **Claude Sonnet 4** (Anthropic) - Main analysis model
- **OpenAI Embeddings** (text-embedding-3-large) - Vector search
- **pgvector** - Vector similarity search
- **Neighbor gem** - pgvector integration

### File Processing
- **pdf-reader** - PDF parsing
- **docx** - DOCX parsing
- **roo** - Excel support
- **ruby-vips** - Image processing

### DevOps & Monitoring
- **Thruster** - HTTP/2 proxy (Rails 8)
- **Mission Control** - Job monitoring
- **Bullet** - N+1 queries detection
- **Annotate** - Schema comments

```


### –ë–∞–∑–æ–≤—ã–π workflow

–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä: http://localhost:3000

#### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ batch
```bash
# –ß–µ—Ä–µ–∑ UI
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ http://localhost:3000/audit_batches
2. –ù–∞–∂–º–∏—Ç–µ "Create New Batch"
3. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ batch
4. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã (PDF, DOCX, TXT)
5. –ù–∞–∂–º–∏—Ç–µ "Upload & Process"

# –ß–µ—Ä–µ–∑ Rails Console
batch = AuditBatch.create!(
  name: "January 2024 Audit",
  total_sheets: 0
)

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ö–õ
ConsultationSheet.create!(
  audit_batch: batch,
  patient_name: "–ñ–∞–Ω–¥–æ—Å –ö.–õ.",
  patient_id: "123456789012",
  diagnosis: "–ì–∏–ø–µ—Ä—Ç–æ–Ω–∏—á–µ—Å–∫–∞—è –±–æ–ª–µ–∑–Ω—å",
  content: File.read("path/to/consultation_sheet.txt")
)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

#### –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–æ–≤
```ruby
# Rails Console
batch = AuditBatch.find(1)

# JSON –æ—Ç—á–µ—Ç
report = ReportGeneratorService.new(batch).generate_summary_report
puts JSON.pretty_generate(report)

# PDF –æ—Ç—á–µ—Ç
pdf = ReportGeneratorService.new(batch).generate_pdf_report
File.write("report_batch_#{batch.id}.pdf", pdf)
```

### CLI Commands

```bash
# Rake tasks –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π

# –ò–º–ø–æ—Ä—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
rails knowledge:import[data/knowledge]

# –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
rails knowledge:search["–∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è –≥–∏–ø–µ—Ä—Ç–µ–Ω–∑–∏—è"]

# –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è embeddings
rails knowledge:reindex

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
rails knowledge:stats
```

### Rails Console Commands

```ruby
# –ó–∞–ø—É—Å–∫ console
rails console

# === –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π ===

# –ü–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
KnowledgeDocument.search("–≥–∏–ø–µ—Ä—Ç–µ–Ω–∑–∏—è", limit: 5)

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å chunking
KnowledgeDocument.create_with_chunking(
  title: "–ü—Ä–æ—Ç–æ–∫–æ–ª –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ê–ì",
  content: File.read("protocol.txt"),
  document_type: :protocol,
  source: "–ú–ó –†–ö 2023"
)

# === –†–∞–±–æ—Ç–∞ —Å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ç–∏–≤–Ω—ã–º–∏ –ª–∏—Å—Ç–∞–º–∏ ===

# –°–æ–∑–¥–∞–Ω–∏–µ –ö–õ
sheet = ConsultationSheet.create!(
  patient_name: "–ü–µ—Ç—Ä–æ–≤ –ü.–ü.",
  diagnosis: "J18 –ü–Ω–µ–≤–º–æ–Ω–∏—è",
  content: "..."
)

# –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞
sheet.analyze!

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
sheet.score          # => 67.5
sheet.risk_level     # => "yellow"
sheet.findings       # => { violations: [...], strengths: [...] }

# === Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ ===

# –°–æ–∑–¥–∞–Ω–∏–µ batch
batch = AuditBatch.create!(name: "Test Batch")

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ö–õ –∫ batch
sheet.update!(audit_batch: batch)
batch.update!(total_sheets: batch.consultation_sheets.count)

# –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
batch.process!

# === RAG —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ===

# –¢–µ—Å—Ç retriever
retriever = RagRetrieverService.new("–ª–µ—á–µ–Ω–∏–µ –≥–∏–ø–µ—Ä—Ç–æ–Ω–∏–∏")
context = retriever.retrieve_context_window(limit: 5)
puts context

# –¢–µ—Å—Ç analyzer
analyzer = AuditAnalyzerService.new(sheet)
result = analyzer.analyze
puts result.to_yaml
```


### --REST Endpoints--

#### Batches

```http
GET /audit_batches
# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö batch

GET /audit_batches/:id
# –î–µ—Ç–∞–ª–∏ batch

GET /audit_batches/:id/summary
# –ö—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ batch

POST /audit_batches
# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ batch

DELETE /audit_batches/:id
# –£–¥–∞–ª–µ–Ω–∏–µ batch
```

#### Consultation Sheets

```http
GET /consultation_sheets
# –°–ø–∏—Å–æ–∫ –ö–õ (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏)

GET /consultation_sheets/:id
# –î–µ—Ç–∞–ª–∏ –ö–õ

POST /consultation_sheets
# –°–æ–∑–¥–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ö–õ

POST /consultation_sheets/bulk_create
# Bulk —Å–æ–∑–¥–∞–Ω–∏–µ –ö–õ

POST /consultation_sheets/:id/reanalyze
# –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ö–õ
```

#### Knowledge Base

```http
GET /knowledge_documents
# –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

GET /knowledge_documents/:id
# –î–µ—Ç–∞–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞

GET /knowledge_documents/search?q=query&limit=10
# –ü–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

POST /knowledge_documents
# –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞

POST /knowledge_documents/import
# Bulk –∏–º–ø–æ—Ä—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```

---

## Testing

```bash
# Setup test database
RAILS_ENV=test rails db:setup

# Run all tests
bundle exec rspec

# Run specific test
bundle exec rspec spec/models/consultation_sheet_spec.rb

# With coverage
COVERAGE=true bundle exec rspec

# Run system tests
bundle exec rspec spec/system
